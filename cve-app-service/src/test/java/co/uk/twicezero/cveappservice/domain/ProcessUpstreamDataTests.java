package co.uk.twicezero.cveappservice.domain;

import builders.NvdTestData;
import org.junit.jupiter.api.Test;

import java.io.IOException;

import static org.junit.jupiter.api.Assertions.assertEquals;

class ProcessUpstreamDataTests {

    @Test
    void procesesesAllGivenCVEs() throws IOException {
        String data = new NvdTestData().build(5).toString();
        ResultsSummary res = ProcessUpstreamData.buildResultsSummary(data);
        assertEquals("description 0", res.topResults.get(0).description);
        assertEquals("description 1", res.topResults.get(1).description);
        assertEquals("description 2", res.topResults.get(2).description);
        assertEquals("description 3", res.topResults.get(3).description);
        assertEquals("description 4", res.topResults.get(4).description);
    }

    @Test
    void producesDataSetForCVE() throws IOException {
        String data = new NvdTestData().build(2).toString();
        ResultsSummary res = ProcessUpstreamData.buildResultsSummary(data);
        assertEquals("description 0", res.topResults.get(0).description);
        assertEquals("2020-04-06T13:15Z", res.topResults.get(0).publishedDate);
        assertEquals("CVE-2020-7635", res.topResults.get(0).id);
        assertEquals("CRITICAL", res.topResults.get(0).severity);
    }

    @Test
    void handlesMissingImpactSection() throws IOException {
        String data = new NvdTestData().removeImpact().build(1).toString();
        ResultsSummary res = ProcessUpstreamData.buildResultsSummary(data);
        assertEquals("description 0", res.topResults.get(0).description);
        assertEquals("2020-04-06T13:15Z", res.topResults.get(0).publishedDate);
        assertEquals("CVE-2020-7635", res.topResults.get(0).id);
        assertEquals(null, res.topResults.get(0).severity);
    }

    @Test
    void handlesNoneNumberTotalResults() throws IOException {
        String data = "{\"totalResults\": \"sausage\", \"result\": {\"CVE_Items\": []}}";
        ResultsSummary res = ProcessUpstreamData.buildResultsSummary(data);
        assertEquals(0, res.totalResults);
    }

}
