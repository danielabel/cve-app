package co.uk.twicezero.cveappservice;

import com.google.gson.Gson;
import com.google.gson.JsonElement;
import com.google.gson.JsonObject;
import com.google.gson.JsonParser;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;

import java.math.BigInteger;

@RestController
public class CVESearchController {

    private final Gson gson = new Gson();

    @RequestMapping("/cve/search")
    public String search() {
        RestTemplate restTemplate = new RestTemplate();

        ResponseEntity<String> response
                = restTemplate.getForEntity("https://services.nvd.nist.gov/rest/json/cpes/1.0", String.class);

        String searchResult = response.getBody();

        // todo: this needs to be more elegant - either using a class model or fluid parsing
        JsonElement json = JsonParser.parseString(searchResult);
        if (json.isJsonObject())
        {
            JsonObject parent = json.getAsJsonObject();
            BigInteger totalResults = parent.get("totalResults").getAsBigInteger();
            return "{totalResults: " + totalResults +  "}";
        }

        // todo: this will need replacing with error handing and a HTTP result
        return "noppers";
    }
}
