package co.uk.twicezero.cveappservice;

import com.fasterxml.jackson.core.JsonProcessingException;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.client.RestTemplate;


@RestController
public class CVESearchController {
    @RequestMapping("/cve/search")
    public String search(@RequestParam(value = "for") String searchFor) {
        try {
        RestTemplate restTemplate = new RestTemplate();

        //todo: we should build this URL up better
        ResponseEntity<String> response
                = restTemplate.getForEntity("https://services.nvd.nist.gov/rest/json/cpes/1.0?keyword=" + searchFor, String.class);

        ObjectMapper mapper = new ObjectMapper();
        JsonNode root = mapper.readTree(response.getBody());
        int totalResults = root.get("totalResults").asInt();
        return "{totalResults: " + totalResults +  "}";

        } catch (JsonProcessingException e) {
            // todo: this will need replacing with error handing and a HTTP result
            e.printStackTrace();
            return "noppers";
        }
    }
}
