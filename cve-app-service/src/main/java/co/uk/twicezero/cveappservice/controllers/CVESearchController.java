package co.uk.twicezero.cveappservice.controllers;

import co.uk.twicezero.cveappservice.domain.ResultsSummary;
import co.uk.twicezero.cveappservice.domain.ProcessUpstreamData;
import co.uk.twicezero.cveappservice.getters.NvdNistGov;
import org.springframework.http.HttpStatus;
import org.springframework.http.ResponseEntity;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;
import org.springframework.web.bind.annotation.RestController;
import org.springframework.web.server.ResponseStatusException;

@RestController
public class CVESearchController {
    @RequestMapping("/cve/search")
    public ResultsSummary search(@RequestParam(value = "for") String searchFor) {
        try {
            ResponseEntity<String> response = NvdNistGov.getData(searchFor);
            return ProcessUpstreamData.buildResultsSummary(response.getBody());
        } catch (Exception exc) {
            // todo: this needs testing!
            System.err.println(exc.getMessage());
            throw new ResponseStatusException(
                    HttpStatus.INTERNAL_SERVER_ERROR, "failed to get  CVE data", exc);
        }
    }
}
