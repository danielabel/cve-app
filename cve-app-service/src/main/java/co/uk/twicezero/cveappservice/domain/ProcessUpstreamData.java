package co.uk.twicezero.cveappservice.domain;

import com.jayway.jsonpath.DocumentContext;
import com.jayway.jsonpath.JsonPath;

import java.util.ArrayList;
import java.util.Collections;
import java.util.List;


public class ProcessUpstreamData {

    private final static String jsonpathTotalResults =   "$['totalResults']";
    private final static String jsonpathCVEDescription = "$['result']['CVE_Items'][*]['cve']['description']['description_data'][0]['value']";
    private final static String jsonpathCVEPubDate =     "$['result']['CVE_Items'][*]['publishedDate']";
    private final static String jsonpathCVEId =          "$['result']['CVE_Items'][*]['cve']['CVE_data_meta']['ID']";

    public static ResultsSummary buildResultsSummary(String responseBody) {
        DocumentContext jsonContext = JsonPath.parse(responseBody);
        int totalResults = jsonContext.read(jsonpathTotalResults);

        if (totalResults == 0) {
            return new ResultsSummary(0, Collections.emptyList());
        }

        ArrayList<ResultsSummary.Cve> cves = getCves(jsonContext);

        return new ResultsSummary(totalResults, cves);
    }

    private static ArrayList<ResultsSummary.Cve> getCves(DocumentContext jsonContext) {
        List<String> cveDescriptions = jsonContext.read(jsonpathCVEDescription);
        List<String> cvePubDates = jsonContext.read(jsonpathCVEPubDate);
        List<String> cveIds = jsonContext.read(jsonpathCVEId);

        // ideally this would be a lovely stream thing - but it likely would be harder to read
        ArrayList<ResultsSummary.Cve> cves = new ArrayList<>(cveDescriptions.size());
        for (int i = 0; i < cveDescriptions.size(); i++) {
            cves.add(new ResultsSummary.Cve(cveDescriptions.get(i), cvePubDates.get(i), cveIds.get(i)));
        }
        return cves;
    }
}
