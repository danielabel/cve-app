package co.uk.twicezero.cveappservice.domain;

import com.jayway.jsonpath.DocumentContext;
import com.jayway.jsonpath.JsonPath;

import java.util.List;
import java.util.stream.Collectors;

public class ProcessUpstreamData {

    public static ResultsSummary buildResultsSummary(String responseBody) {
        String jsonpathTotalResults = "$['totalResults']";
        String jsonpathCVEDescription = "$['result']['CVE_Items'][*]['cve']['description']['description_data'][0]['value']";

        DocumentContext jsonContext = JsonPath.parse(responseBody);
        int totalResults = jsonContext.read(jsonpathTotalResults);
        List<String> cveDescriptions = jsonContext.read(jsonpathCVEDescription);

        List<ResultsSummary.Cve> cves = cveDescriptions.stream()
                .map(ResultsSummary.Cve::new)
                .collect(Collectors.toList());

        return new ResultsSummary(totalResults, cves);
    }
}
